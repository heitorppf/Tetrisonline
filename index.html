<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>Tetris simples com Login / Cadastro</title>
<style>
  /* Reset básico e fonte */
  * {
    box-sizing: border-box;
  }
  body {
    margin:0; padding:0;
    background:#111;
    color:#eee;
    font-family: monospace, monospace;
    display:flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
  }
  h1 {
    margin-bottom: 0.5em;
    user-select:none;
  }

  /* Container Login / Cadastro */
  #loginScreen {
    max-width: 420px;
    width: 95vw;
    padding: 15px 10px;
  }
  input, button {
    font-size: 1.1em;
    padding: 10px;
    margin: 6px 0;
    border-radius: 5px;
    border:none;
    width: 100%;
  }
  input {
    outline: none;
  }
  button {
    background:#00ffff;
    color:#000;
    cursor: pointer;
    font-weight: bold;
    user-select:none;
    transition: background 0.2s ease;
  }
  button:hover {
    background:#0cc;
  }
  .small-btns {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin: 10px 0 20px 0;
  }
  .small-btns button {
    width: 48%;
  }
  .error {
    color:#f44;
    font-weight: bold;
    min-height: 1.4em;
  }

  /* Tela do jogo */
  #gameScreen {
    display: none;
    flex-direction: column;
    align-items: center;
    max-width: 420px;
    width: 95vw;
    padding: 10px 5px 30px 5px;
  }

  #score {
    font-size: 1.4em;
    margin-bottom: 6px;
    user-select:none;
  }

  canvas {
    background:#000;
    display: block;
    width: 100%;
    max-width: 400px;
    aspect-ratio: 10 / 20;
    border: 4px solid #00ffff;
    border-radius: 8px;
    touch-action: none;
    user-select:none;
  }

  #controls {
    margin-top: 10px;
    display: flex;
    justify-content: center;
    gap: 12px;
  }
  #controls button {
    flex: 1;
    font-size: 1.6em;
    padding: 10px 0;
    background: #00ffff;
    color:#000;
    border-radius: 6px;
    user-select:none;
  }
  #controls button:hover {
    background:#0cc;
  }

  #btnLogout {
    margin-top: 20px;
    background:#f44;
    color:#fff;
    font-weight: bold;
  }

  /* Leaderboard simples */
  #leaderboard {
    margin-top: 18px;
    font-size: 0.9em;
    color: #0ff;
    font-family: monospace;
    max-height: 140px;
    overflow-y: auto;
    user-select:none;
  }
  #leaderboard table {
    width: 100%;
    border-collapse: collapse;
  }
  #leaderboard th, #leaderboard td {
    padding: 4px 6px;
    border-bottom: 1px solid #0ff;
    text-align: left;
  }
  #leaderboard tr:nth-child(even) {
    background: #111;
  }

</style>
</head>
<body>

<div id="loginScreen">
  <h1>Tetris Simples</h1>
  <div id="loginForms">

    <!-- Botões iniciais -->
    <div id="initialBtns">
      <button id="btnPlayGuest">Jogar Sem Login</button>
      <div class="small-btns">
        <button id="btnShowLogin">Login</button>
        <button id="btnShowRegister">Cadastrar</button>
      </div>
    </div>

    <!-- Form Login -->
    <div id="formLogin" style="display:none;">
      <input type="text" id="loginUser" placeholder="Email ou Usuário" autocomplete="username" />
      <input type="password" id="loginPass" placeholder="Senha" autocomplete="current-password" />
      <button id="btnLogin">Entrar</button>
      <button id="btnCancelLogin" style="background:#555; color:#ddd; margin-top:10px;">Cancelar</button>
      <div class="error" id="errorLogin"></div>
    </div>

    <!-- Form Cadastro -->
    <div id="formRegister" style="display:none;">
      <input type="text" id="regUser" placeholder="Usuário (min 3 caracteres)" autocomplete="username" />
      <input type="email" id="regEmail" placeholder="Email válido" autocomplete="email" />
      <input type="password" id="regPass" placeholder="Senha (min 6 caracteres)" autocomplete="new-password" />
      <button id="btnRegister">Criar Conta</button>
      <button id="btnCancelRegister" style="background:#555; color:#ddd; margin-top:10px;">Cancelar</button>
      <div class="error" id="errorRegister"></div>
    </div>

  </div>
</div>

<div id="gameScreen">
  <div id="score">Score: 0</div>
  <canvas id="tetris"></canvas>

  <div id="controls">
    <button id="btnLeft" aria-label="Mover para esquerda">◄</button>
    <button id="btnRotate" aria-label="Rotacionar peça">⟳</button>
    <button id="btnRight" aria-label="Mover para direita">►</button>
  </div>
  <button id="btnLogout">Sair do jogo</button>

  <div id="leaderboard"><b>Leaderboard</b><br>Carregando...</div>
</div>

<script>
(() => {
  // Variáveis DOM
  const loginScreen = document.getElementById('loginScreen');
  const gameScreen = document.getElementById('gameScreen');

  const btnPlayGuest = document.getElementById('btnPlayGuest');
  const btnShowLogin = document.getElementById('btnShowLogin');
  const btnShowRegister = document.getElementById('btnShowRegister');

  const formLogin = document.getElementById('formLogin');
  const loginUser = document.getElementById('loginUser');
  const loginPass = document.getElementById('loginPass');
  const btnLogin = document.getElementById('btnLogin');
  const btnCancelLogin = document.getElementById('btnCancelLogin');
  const errorLogin = document.getElementById('errorLogin');

  const formRegister = document.getElementById('formRegister');
  const regUser = document.getElementById('regUser');
  const regEmail = document.getElementById('regEmail');
  const regPass = document.getElementById('regPass');
  const btnRegister = document.getElementById('btnRegister');
  const btnCancelRegister = document.getElementById('btnCancelRegister');
  const errorRegister = document.getElementById('errorRegister');

  const scoreEl = document.getElementById('score');
  const canvas = document.getElementById('tetris');
  const ctx = canvas.getContext('2d');

  const btnLeft = document.getElementById('btnLeft');
  const btnRight = document.getElementById('btnRight');
  const btnRotate = document.getElementById('btnRotate');
  const btnLogout = document.getElementById('btnLogout');

  const leaderboardEl = document.getElementById('leaderboard');

  // Constantes do jogo
  const COLS = 10;
  const ROWS = 20;
  let BLOCK_SIZE = 0;

  function resizeCanvas(){
    const width = Math.min(window.innerWidth * 0.95, 400);
    BLOCK_SIZE = Math.floor(width / COLS);
    canvas.width = COLS * BLOCK_SIZE;
    canvas.height = ROWS * BLOCK_SIZE;
  }

  resizeCanvas();
  window.addEventListener('resize', () => {
    resizeCanvas();
    draw();
  });

  // Cores das peças
  const colors = [
    null,
    '#00ffff', // I
    '#ffff00', // O
    '#8000ff', // T
    '#ff8000', // L
    '#0000ff', // J
    '#00ff00', // S
    '#ff0000'  // Z
  ];

  // Peças
  const tetrominos = {
    'I': [[1,1,1,1]],
    'O': [[2,2],[2,2]],
    'T': [[0,3,0],[3,3,3]],
    'L': [[4,4,4],[4,0,0]],
    'J': [[5,5,5],[0,0,5]],
    'S': [[0,6,6],[6,6,0]],
    'Z': [[7,7,0],[0,7,7]]
  };

  // Estado do jogo
  let arena = [];
  let player = {
    pos: {x:0, y:0},
    matrix: null,
    score: 0
  };

  // Game loop control
  let dropCounter = 0;
  let dropInterval = 800;
  let lastTime = 0;
  let animationId;
  let playing = false;

  // Usuário atual logado ou null
  let currentUser = null;

  // --- Utils ---

  function createMatrix(w,h){
    const matrix = [];
    for(let i=0;i<h;i++){
      matrix.push(new Array(w).fill(0));
    }
    return matrix;
  }

  function drawMatrix(matrix, offset){
    for(let y=0;y<matrix.length;y++){
      for(let x=0;x<matrix[y].length;x++){
        if(matrix[y][x] !== 0){
          ctx.fillStyle = colors[matrix[y][x]];
          ctx.fillRect(
            (offset.x + x) * BLOCK_SIZE,
            (offset.y + y) * BLOCK_SIZE,
            BLOCK_SIZE,
            BLOCK_SIZE
          );
          ctx.strokeStyle = '#222';
          ctx.lineWidth = 2;
          ctx.strokeRect(
            (offset.x + x) * BLOCK_SIZE,
            (offset.y + y) * BLOCK_SIZE,
            BLOCK_SIZE,
            BLOCK_SIZE
          );
        }
      }
    }
  }

  function merge(arena, player){
    player.matrix.forEach((row,y) => {
      row.forEach((value,x) => {
        if(value !== 0){
          arena[y + player.pos.y][x + player.pos.x] = value;
        }
      });
    });
  }

  function collide(arena, player){
    for(let y=0; y < player.matrix.length; y++){
      for(let x=0; x < player.matrix[y].length; x++){
        if(player.matrix[y][x] !== 0 &&
          (arena[y + player.pos.y] && arena[y + player.pos.y][x + player.pos.x]) !== 0){
            return true;
          }
      }
    }
    return false;
  }

  function rotate(matrix){
    const N = matrix.length;
    const result = createMatrix(N,N);
    for(let y=0; y<N; y++){
      for(let x=0; x<N; x++){
        result[x][N - y -1] = matrix[y][x];
      }
    }
    return result;
  }

  function arenaSweep(){
    let rowCount = 0;
    outer: for(let y=arena.length-1; y>=0; y--){
      for(let x=0; x<arena[y].length; x++){
        if(arena[y][x] === 0){
          continue outer;
        }
      }
      const row = arena.splice(y,1)[0].fill(0);
      arena.unshift(row);
      rowCount++;
      y++;
    }
    if(rowCount > 0){
      player.score += rowCount * rowCount * 100;
      updateScore();
    }
  }

  function updateScore(){
    scoreEl.textContent = `Score: ${player.score}`;
  }

  function playerReset(){
    const pieces = 'IJLOSTZ';
    const pieceType = pieces[Math.floor(Math.random() * pieces.length)];
    player.matrix = tetrominos[pieceType];
    player.pos.y = 0;
    player.pos.x = Math.floor((COLS - player.matrix[0].length) / 2);
    if(collide(arena, player)){
      alert(`Game Over! Sua pontuação: ${player.score}`);
      saveScore();
      playing = false;
      cancelAnimationFrame(animationId);
      showLoginScreen();
    }
  }

  function playerDrop(){
    player.pos.y++;
    if(collide(arena, player)){
      player.pos.y--;
      merge(arena, player);
      arenaSweep();
      playerReset();
    }
    dropCounter = 0;
  }

  function playerMove(dir){
    player.pos.x += dir;
    if(collide(arena, player)){
      player.pos.x -= dir;
    }
  }

  function playerRotate(){
    const pos = player.pos.x;
    player.matrix = rotate(player.matrix);
    if(collide(arena, player)){
      player.pos.x = pos;
      // desrotaciona se colidir
      for(let i=0; i<3; i++) player.matrix = rotate(player.matrix);
    }
  }

  function draw(){
    ctx.fillStyle = '#000';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    drawMatrix(arena, {x:0,y:0});
    drawMatrix(player.matrix, player.pos);
  }

  function update(time=0){
    if(!playing) return;
    const deltaTime = time - lastTime;
    lastTime = time;

    dropCounter += deltaTime;
    if(dropCounter > dropInterval){
      playerDrop();
    }
    draw();
    animationId = requestAnimationFrame(update);
  }

  // --- Login / Cadastro simples ---
  // Guardar no localStorage: users = [{user,email,pass,score}]
  // currentUser = {user,email}

  function loadUsers(){
    const str = localStorage.getItem('tetrisUsers');
    if(!str) return [];
    try {
      return JSON.parse(str);
    } catch {
      return [];
    }
  }

  function saveUsers(users){
    localStorage.setItem('tetrisUsers', JSON.stringify(users));
  }

  function setCurrentUser(user){
    if(!user){
      localStorage.removeItem('tetrisCurrentUser');
      currentUser = null;
    } else {
      localStorage.setItem('tetrisCurrentUser', JSON.stringify(user));
      currentUser = user;
    }
  }

  function getCurrentUser(){
    if(currentUser) return currentUser;
    const str = localStorage.getItem('tetrisCurrentUser');
    if(!str) return null;
    try {
      currentUser = JSON.parse(str);
      return currentUser;
    } catch {
      return null;
    }
  }

  function showLoginScreen(){
    gameScreen.style.display = 'none';
    loginScreen.style.display = 'block';
    formLogin.style.display = 'none';
    formRegister.style.display = 'none';
    document.getElementById('initialBtns').style.display = 'block';
    errorLogin.textContent = '';
    errorRegister.textContent = '';
  }

  function showGameScreen(){
    loginScreen.style.display = 'none';
    gameScreen.style.display = 'flex';
    updateScore();
    renderLeaderboard();
  }

  // Validação simples email
  function validEmail(email){
    return /\S+@\S+\.\S+/.test(email);
  }

  // Login handlers
  btnShowLogin.onclick = () => {
    formLogin.style.display = 'block';
    formRegister.style.display = 'none';
    document.getElementById('initialBtns').style.display = 'none';
    errorLogin.textContent = '';
  };

  btnShowRegister.onclick = () => {
    formRegister.style.display = 'block';
    formLogin.style.display = 'none';
    document.getElementById('initialBtns').style.display = 'none';
    errorRegister.textContent = '';
  };

  btnCancelLogin.onclick = () => {
    formLogin.style.display = 'none';
    document.getElementById('initialBtns').style.display = 'block';
    errorLogin.textContent = '';
  };

  btnCancelRegister.onclick = () => {
    formRegister.style.display = 'none';
    document.getElementById('initialBtns').style.display = 'block';
    errorRegister.textContent = '';
  };

  btnRegister.onclick = () => {
    const u = regUser.value.trim();
    const e = regEmail.value.trim().toLowerCase();
    const p = regPass.value;
    errorRegister.textContent = '';

    if(u.length < 3){
      errorRegister.textContent = 'Usuário precisa ter no mínimo 3 caracteres.';
      return;
    }
    if(!validEmail(e)){
      errorRegister.textContent = 'Email inválido.';
      return;
    }
    if(p.length < 6){
      errorRegister.textContent = 'Senha precisa ter no mínimo 6 caracteres.';
      return;
    }

    const users = loadUsers();
    if(users.find(x => x.user.toLowerCase() === u.toLowerCase())){
      errorRegister.textContent = 'Usuário já existe.';
      return;
    }
    if(users.find(x => x.email === e)){
      errorRegister.textContent = 'Email já cadastrado.';
      return;
    }

    users.push({user: u, email: e, pass: p, score: 0});
    saveUsers(users);
    alert('Conta criada com sucesso! Faça login agora.');
    regUser.value = '';
    regEmail.value = '';
    regPass.value = '';
    formRegister.style.display = 'none';
    document.getElementById('initialBtns').style.display = 'block';
  };

  btnLogin.onclick = () => {
    const login = loginUser.value.trim();
    const pass = loginPass.value;
    errorLogin.textContent = '';
    if(!login || !pass){
      errorLogin.textContent = 'Preencha todos os campos.';
      return;
    }

    const users = loadUsers();

    // Tenta achar pelo usuário ou email
    const found = users.find(u => 
      (u.user.toLowerCase() === login.toLowerCase() || u.email === login.toLowerCase()) 
      && u.pass === pass
    );
    if(!found){
      errorLogin.textContent = 'Usuário ou senha incorretos.';
      return;
    }

    setCurrentUser({user: found.user, email: found.email});
    loginUser.value = '';
    loginPass.value = '';
    startGame();
  };

  btnPlayGuest.onclick = () => {
    setCurrentUser(null);
    startGame();
  };

  btnLogout.onclick = () => {
    setCurrentUser(null);
    stopGame();
    showLoginScreen();
  };

  // --- Jogo ---
  function startGame(){
    arena = createMatrix(COLS, ROWS);
    player.score = 0;
    playerReset();
    updateScore();
    playing = true;
    lastTime = 0;
    dropCounter = 0;
    showGameScreen();
    animationId = requestAnimationFrame(update);
  }

  function stopGame(){
    playing = false;
    cancelAnimationFrame(animationId);
  }

  // Salvar recorde do jogador logado (se for guest, não salva)
  function saveScore(){
    if(!currentUser) return;
    const users = loadUsers();
    const idx = users.findIndex(u => u.user === currentUser.user && u.email === currentUser.email);
    if(idx >= 0 && player.score > users[idx].score){
      users[idx].score = player.score;
      saveUsers(users);
    }
    renderLeaderboard();
  }

  // Leaderboard simples: top 5 maiores scores dos usuários
  function renderLeaderboard(){
    const users = loadUsers();
    if(users.length === 0){
      leaderboardEl.innerHTML = '<b>Leaderboard</b><br>Nenhum jogador cadastrado.';
      return;
    }
    const sorted = [...users].sort((a,b) => b.score - a.score).slice(0,5);
    let html = '<b>Leaderboard</b><br><table><thead><tr><th>Usuário</th><th>Score</th></tr></thead><tbody>';
    for(let u of sorted){
      html += `<tr><td>${u.user}</td><td>${u.score}</td></tr>`;
    }
    html += '</tbody></table>';
    leaderboardEl.innerHTML = html;
  }

  // --- Controles ---
  document.addEventListener('keydown', e => {
    if(!playing) return;
    if(e.repeat) return;
    if(e.key === 'ArrowLeft') playerMove(-1);
    else if(e.key === 'ArrowRight') playerMove(1);
    else if(e.key === 'ArrowDown') playerDrop();
    else if(e.key === 'ArrowUp' || e.key.toLowerCase() === 'x') playerRotate();
  });

  btnLeft.onclick = () => { if(playing) playerMove(-1); };
  btnRight.onclick = () => { if(playing) playerMove(1); };
  btnRotate.onclick = () => { if(playing) playerRotate(); };

  // Inicia na tela de login
  showLoginScreen();

})();
</script>

</body>
</html>
